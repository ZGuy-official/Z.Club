// ===== PLAYER =====
let playerName = localStorage.getItem("playerName");
let playerId = localStorage.getItem("playerId") ||
  crypto.randomUUID().slice(0,8);

localStorage.setItem("playerId", playerId);

function initPlayer(){
  if(!playerName){
    playerName = prompt("Enter your name") || "Sitemen";
    localStorage.setItem("playerName", playerName);
  }
  document.getElementById("playerName").innerText = playerName;
  document.getElementById("playerId").innerText = playerId;
}
initPlayer();

function changeName(){
  let n = prompt("New name:", playerName);
  if(n){
    playerName = n.slice(0,12);
    localStorage.setItem("playerName", playerName);
    initPlayer();
  }
}

// ===== SAVE =====
let cash = Number(localStorage.getItem("cash")) || 100;
let inventory = JSON.parse(localStorage.getItem("inventory")) || {};
let lastDaily = Number(localStorage.getItem("lastDaily")) || 0;
let luck = 1, boosterTimer;

// ===== UTIL =====
function save(){
  localStorage.setItem("cash", cash);
  localStorage.setItem("inventory", JSON.stringify(inventory));
}

function updateVIP(){
  document.body.className =
    cash >= 100000 ? "gold" :
    cash >= 25000 ? "silver" :
    cash >= 5000 ? "bronze" : "";
}

function updateCash(){
  document.getElementById("cashAmount").innerText = cash;
  updateVIP();
  save();
}
updateCash();

// ===== MUSIC =====
let musicOn = false;
function toggleMusic(){
  let m = document.getElementById("clubMusic");
  musicOn ? m.pause() : m.play();
  musicOn = !musicOn;
}

// ===== BLACKJACK =====
let player=0,dealer=0,bet=0,playing=false;
const card=()=>Math.floor(Math.random()*10)+1;

function deal(){
  if(playing) return;
  bet = +document.getElementById("bet").value;
  if(bet<=0||bet>cash) return alert("Invalid bet");
  cash-=bet;
  player=card()+card();
  dealer=card();
  playing=true;
  document.getElementById("bjStatus").innerText=`You:${player} Dealer:${dealer}`;
  updateCash();
}

function hit(){
  if(!playing) return;
  player+=card();
  player>21?end(false):
  document.getElementById("bjStatus").innerText=`You:${player} Dealer:${dealer}`;
}

function stand(){
  if(!playing) return;
  while(dealer<17) dealer+=card();
  if(player===dealer){ cash+=bet; playing=false; updateCash(); return;}
  end(player>dealer||dealer>21);
}

function end(win){
  playing=false;
  if(win){ cash+=bet*2; }
  updateCash();
}

// ===== RNG =====
const loot=["Candy","Cake","Fish","Steak","Chicken"];
function spinWheel(){
  if(cash<500) return;
  cash-=500;
  let item=loot[Math.floor(Math.random()*loot.length/luck)];
  inventory[item]=(inventory[item]||0)+1;
  document.getElementById("rngResult").innerText="You got "+item;
  updateInventory(); updateCash();
}

// ===== INVENTORY =====
function updateInventory(){
  let ul=document.getElementById("inventory");
  ul.innerHTML="";
  for(let k in inventory)
    ul.innerHTML+=`<li>${k} x${inventory[k]}</li>`;
  save();
}
updateInventory();

// ===== SHOP =====
function buyBooster(min){
  let cost=min===1?1000:5000;
  if(cash<cost) return;
  cash-=cost;
  luck=2;
  clearTimeout(boosterTimer);
  boosterTimer=setTimeout(()=>luck=1,min*60000);
  updateCash();
}

// ===== DAILY =====
function claimDaily(){
  let now=Date.now();
  if(now-lastDaily<86400000) return;
  let r=1000+Math.floor(Math.random()*1000);
  cash+=r;
  lastDaily=now;
  localStorage.setItem("lastDaily",lastDaily);
  updateCash();
}

// ===== SLOTS =====
const symbols=["ðŸ’","ðŸ‹","ðŸ””","ðŸ’Ž","7ï¸âƒ£"];
function spinSlots(){
  if(cash<250) return;
  cash-=250;
  let s=()=>symbols[Math.floor(Math.random()*symbols.length/luck)];
  let a=s(),b=s(),c=s();
  document.getElementById("slots").innerText=`${a} ${b} ${c}`;
  if(a===b&&b===c) cash+=a==="7ï¸âƒ£"?5000:1000;
  updateCash();
}

// ===== CODES =====
function redeemCode(){
  let c=document.getElementById("codeInput").value.toUpperCase();
  if(c==="WELCOME") cash+=1000;
  updateCash();
}

// ===== EXPORT / IMPORT =====
function exportSave(){
  let data = JSON.stringify(localStorage);
  let blob=new Blob([data],{type:"application/json"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`zclub_${playerName}.json`;
  a.click();
}

function importSave(e){
  let file=e.target.files[0];
  if(!file) return;
  let r=new FileReader();
  r.onload=()=>{ let d=JSON.parse(r.result);
    for(let k in d) localStorage.setItem(k,d[k]);
    location.reload();
  };
  r.readAsText(file);
}
