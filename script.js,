// ================== DATA ==================
let cash = Number(localStorage.getItem("cash")) || 100;
let inventory = JSON.parse(localStorage.getItem("inventory")) || {};
let achievements = JSON.parse(localStorage.getItem("achievements")) || {};
let usedCodes = JSON.parse(localStorage.getItem("usedCodes")) || {};
let luck = 1;
let boosterTimer = null;
let lastDaily = Number(localStorage.getItem("lastDaily")) || 0;

// ================== SAVE ==================
function save() {
  localStorage.setItem("cash", cash);
  localStorage.setItem("inventory", JSON.stringify(inventory));
  localStorage.setItem("achievements", JSON.stringify(achievements));
  localStorage.setItem("usedCodes", JSON.stringify(usedCodes));
}

// ================== CASH ==================
function updateCash() {
  document.getElementById("cashAmount").innerText = cash;
  if (cash >= 10000) unlock("High Roller");
  save();
}
updateCash();

// ================== MUSIC ==================
let musicOn = false;
const music = document.getElementById("clubMusic");

function toggleMusic() {
  musicOn = !musicOn;
  musicOn ? music.play() : music.pause();
}

// ================== ACHIEVEMENTS ==================
function unlock(name) {
  if (achievements[name]) return;
  achievements[name] = true;
  alert("üèÜ Achievement Unlocked: " + name);
  save();
}

// ================== BLACKJACK ==================
let player = 0, dealer = 0, bet = 0, playing = false;

function card() {
  return Math.floor(Math.random() * 10) + 1;
}

function deal() {
  bet = Number(document.getElementById("bet").value);
  if (bet <= 0 || bet > cash) return alert("Invalid bet");
  cash -= bet;

  player = card() + card();
  dealer = card();
  playing = true;

  document.getElementById("bjStatus").innerText =
    `You: ${player} | Dealer: ${dealer}`;
  updateCash();
}

function hit() {
  if (!playing) return;
  player += card();
  if (player > 21) end(false);
  else
    document.getElementById("bjStatus").innerText =
      `You: ${player} | Dealer: ${dealer}`;
}

function stand() {
  if (!playing) return;
  while (dealer < 17) dealer += card();
  end(player > dealer || dealer > 21);
}

function end(win) {
  playing = false;
  if (win) {
    cash += bet * 2;
    unlock("First Blackjack Win");
    document.getElementById("bjStatus").innerText = "You win!";
  } else {
    document.getElementById("bjStatus").innerText = "You lose!";
  }
  updateCash();
}

// ================== RNG WHEEL ==================
const loot = [
  { n: "Candy", c: 100, img: "candy.png" },
  { n: "Cake", c: 200, img: "cake.png" },
  { n: "Fish", c: 500, img: "fish.png" },
  { n: "Steak", c: 800, img: "steak.png" },
  { n: "Chicken", c: 1000, img: "chicken.png" }
];

function spinWheel() {
  if (cash < 500) return alert("Not enough cash");
  cash -= 500;

  document.getElementById("wheel").style.transform =
    "rotate(" + Math.random() * 1080 + "deg)";

  let roll = Math.floor(Math.random() * (1000 / luck)) + 1;
  let won = "Nothing";

  for (let i of loot) {
    if (roll <= i.c) {
      won = i.n;
      addItem(i);
      break;
    }
  }

  unlock("First RNG Spin");
  document.getElementById("rngResult").innerText = "You got: " + won;
  updateCash();
}

// ================== INVENTORY ==================
function addItem(item) {
  inventory[item.n] = Math.min((inventory[item.n] || 0) + 1, 999);
  updateInventory();
}

function updateInventory() {
  let ul = document.getElementById("inventory");
  ul.innerHTML = "";
  let total = 0;

  for (let i of loot) {
    if (inventory[i.n]) {
      total += inventory[i.n];
      ul.innerHTML += `
        <li>
          <img src="images/${i.img}">
          ${i.n} x${inventory[i.n]}
        </li>`;
    }
  }

  if (total >= 10) unlock("Collector");
  if (total >= 100) unlock("Hoarder");

  save();
}
updateInventory();

// ================== SHOP ==================
function buyBooster(min) {
  let cost = min === 1 ? 1000 : 5000;
  if (cash < cost) return alert("Not enough cash");
  cash -= cost;
  luck = 2;

  document.getElementById("boosterStatus").innerText =
    `Luck x2 for ${min} min`;

  clearTimeout(boosterTimer);
  boosterTimer = setTimeout(() => {
    luck = 1;
    document.getElementById("boosterStatus").innerText = "Luck expired";
  }, min * 60000);

  updateCash();
}

// ================== DAILY REWARD ==================
function claimDaily() {
  const now = Date.now();
  const day = 86400000;

  if (now - lastDaily < day) {
    document.getElementById("dailyStatus").innerText =
      "Come back later";
    return;
  }

  let reward = 1000 + Math.floor(Math.random() * 1000);
  cash += reward;
  lastDaily = now;

  localStorage.setItem("lastDaily", lastDaily);
  unlock("Daily Visitor");
  updateCash();

  document.getElementById("dailyStatus").innerText =
    `You got $${reward}!`;
}

// ================== SLOTS ==================
const symbols = ["üçí", "üçã", "üîî", "üíé", "7Ô∏è‚É£"];

function spinSlots() {
  if (cash < 250) return alert("Not enough cash");
  cash -= 250;

  let s1 = symbols[Math.floor(Math.random() * symbols.length)];
  let s2 = symbols[Math.floor(Math.random() * symbols.length)];
  let s3 = symbols[Math.floor(Math.random() * symbols.length)];

  document.getElementById("slots").innerText = `${s1} ${s2} ${s3}`;

  let win = 0;
  if (s1 === s2 && s2 === s3) {
    win = s1 === "7Ô∏è‚É£" ? 5000 : 1000;
    unlock("Slot Jackpot");
  } else if (s1 === s2 || s2 === s3) {
    win = 500;
  }

  cash += win;
  document.getElementById("slotResult").innerText =
    win ? `You won $${win}!` : "No win";
  updateCash();
}

// ================== CODES ==================
function redeemCode() {
  let input = document.getElementById("codeInput").value
    .trim()
    .toUpperCase();
  let status = document.getElementById("codeStatus");

  const codes = {
    "WELCOME": () => cash += 1000,
    "ZCLUB": () => cash += 5000,
    "RICH": () => cash += 10000,
    "LUCKY": () => { luck = 2; setTimeout(() => luck = 1, 60000); },
    "CANDY": () => addItem({ n: "Candy", img: "candy.png" }),
    "STEAK": () => addItem({ n: "Steak", img: "steak.png" })
  };

  if (usedCodes[input]) {
    status.innerText = "‚ùå Code already used";
    return;
  }

  if (!codes[input]) {
    status.innerText = "‚ùå Invalid code";
    return;
  }

  codes[input]();
  usedCodes[input] = true;
  unlock("Code Breaker");
  updateCash();

  status.innerText = "‚úÖ Code redeemed!";
}
